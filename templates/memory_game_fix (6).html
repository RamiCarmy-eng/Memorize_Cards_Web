<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Memory Game Pro</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #e67e22;
            --bg: #2c3e50;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            text-align: center;
        }

        .hidden { display: none !important; }

        #login-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .red { background: #c0392b !important; color: white !important; }

        .container-glass {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            width: 350px;
        }

        #status-bar {
            font-size: 18px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-bottom: 3px solid var(--primary);
            position: sticky; top: 0; z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #sound-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 20px;
            transition: 0.3s;
        }
        #sound-toggle:hover {
            background: rgba(255,255,255,0.2);
        }

        input {
            padding: 12px; border-radius: 8px; border: none; width: 100%;
            margin: 10px 0; font-size: 16px; box-sizing: border-box;
        }

        .btn {
            padding: 12px 20px; font-size: 16px; margin: 8px 0; cursor: pointer;
            border: none; border-radius: 8px; color: white; font-weight: bold;
            transition: 0.3s; width: 100%;
        }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .blue { background: var(--primary); }
        .orange { background: var(--secondary); }
        .yellow { background: #f1c40f; color: #2c3e50; }

        #board { display: grid; gap: 10px; justify-content: center; margin: 20px auto; }
        .card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer; 
            border-radius: 8px; 
            border: 3px solid #2c3e50; 
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .card::before {
            content: '?';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: white;
            font-weight: bold;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .card img { 
            width: 100%; 
            height: 100%; 
            border-radius: 6px; 
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card.flipped::before {
            opacity: 0;
        }
        .card.flipped { 
            background: white;
        }
        .card.flipped img { 
            opacity: 1;
        }
        .card.matched { 
            border: 3px solid #27ae60; 
            cursor: default; 
        }
        .card.matched::before {
            opacity: 0;
        }
        .card.matched img {
            opacity: 1;
        }
    </style>
</head>
<body>

    <div id="status-bar" class="hidden">
        <span id="status-text"></span>
        <button id="sound-toggle" onclick="toggleSound(); return false;" title="Sound On">ğŸ”Š</button>
    </div>

    <div id="login-screen">
        <div class="container-glass">
            <h1>ğŸ§  ×–×™×›×¨×•×Ÿ</h1>

            <input type="text" id="p1-name" placeholder="×©× ××©×ª××©" autocomplete="off" autocorrect="off" spellcheck="false">
            <input type="text" id="p1-pass" placeholder="×¡×™×¡××”" autocomplete="off" autocorrect="off" spellcheck="false" onfocus="this.type='password'">

            <div id="p2-area" class="hidden">
                <hr style="opacity:0.2; margin: 20px 0;">
                <input type="text" id="p2-name" placeholder="×©× ×©×—×§×Ÿ 2" autocomplete="off">
                <input type="text" id="p2-pass" placeholder="×¡×™×¡××” ×©×—×§×Ÿ 2" autocomplete="off" onfocus="this.type='password'">
            </div>

            <div class="login-buttons">
                <button class="btn blue" onclick="handleAuth()">×›× ×™×¡×” ×œ××©×—×§</button>
                <button id="multi-btn" class="btn orange" onclick="toggleMulti()">ğŸ‘¥ ××¦×‘ ×–×•×’×™</button>
                <button class="btn yellow" onclick="loadLeaderboard()">ğŸ† ×œ×•×— ×”×™×©×’×™×</button>
            </div>
        </div>
    </div>

    <div id="difficulty-screen" class="hidden"></div>
    <div id="leaderboard" style="text-align:center; display:none;"></div>

    <div id="game-screen" class="hidden">
        <div id="board"></div>
        <div style="margin-top: 20px; padding-bottom: 40px;">
            <button id="play-again-btn" class="btn blue hidden" style="width:200px" onclick="initGame(game.rows, game.cols)">×©×—×§ ×©×•×‘</button>
            <button id="change-diff-btn" class="btn yellow hidden" style="width:200px" onclick="changeDifficulty()">×©× ×” ×¨××ª ×§×•×©×™</button>
            <br>
            <button class="btn orange" style="width:200px" onclick="location.reload()">×™×¦×™××”</button>
        </div>
    </div>

    <script>
        let game = {
            mode: 'Single', p1: null, p2: null,
            flipped: [], turns: 0, matches: 0,
            currentPlayer: 1, scores: {1:0, 2:0},
            rows: 0, cols: 0, currentDifficulty: '',
            startTime: null, timerInterval: null
        };

        function toggleMulti() {
            const area = document.getElementById('p2-area');
            const btn = document.getElementById('multi-btn');
            if (!area || !btn) return;

            area.classList.toggle('hidden');

            if (area.classList.contains('hidden')) {
                game.mode = 'Single';
                btn.innerHTML = 'ğŸ‘¥ ××¦×‘ ×–×•×’×™';
                const p2n = document.getElementById('p2-name');
                const p2p = document.getElementById('p2-pass');
                if (p2n) p2n.value = '';
                if (p2p) p2p.value = '';
            } else {
                game.mode = 'Multi';
                btn.innerHTML = 'ğŸ‘¤ ×©×—×§ ×œ×‘×“ (×‘×˜×œ ×©×—×§×Ÿ 2)';
            }
        }

        function logout() {
            game.p1 = null;
            game.p2 = null;
            game.mode = 'Single';
            document.getElementById('p1-name').value = '';
            document.getElementById('p1-pass').value = '';
            const p2name = document.getElementById('p2-name');
            const p2pass = document.getElementById('p2-pass');
            if(p2name) p2name.value = '';
            if(p2pass) p2pass.value = '';
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('difficulty-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('status-bar').classList.add('hidden');
            document.getElementById('p2-area').classList.add('hidden');
        }

        async function verify(name, pass) {
            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name, password: pass })
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.message || "×©×’×™××” ×‘×¤×¨×˜×™×");
                    return null;
                }
                return data;
            } catch (err) {
                console.error("Fetch error:", err);
                alert("×©×’×™××” ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª");
                return null;
            }
        }

        async function handleAuth() {
            console.log("Starting Auth...");
            const n1 = document.getElementById('p1-name').value;
            const p1 = document.getElementById('p1-pass').value;

            if (!n1 || !p1) {
                alert("× × ×œ××œ× ×©× ×•×¡×™×¡××” ×œ×©×—×§×Ÿ 1");
                return;
            }

            const u1 = await verify(n1, p1);
            if (!u1) {
                console.log("Verification failed for Player 1");
                return;
            }

            game.p1 = {
                name: n1,
                best_scores: u1.user.best_scores || {"4x4": null, "6x6": null, "8x8": null}
            };

            if (game.mode === 'Multi') {
                const n2 = document.getElementById('p2-name').value;
                const p2 = document.getElementById('p2-pass').value;
                if (!n2 || !p2) {
                    alert("× × ×œ××œ× ×¤×¨×˜×™× ×œ×©×—×§×Ÿ 2");
                    return;
                }
                const u2 = await verify(n2, p2);
                if (!u2) return;
                game.p2 = { name: n2 };
            }

            console.log("Auth success! Moving to difficulty screen...");
            showDifficultyScreen();
        }

        function showDifficultyScreen() {
            const ds = document.getElementById('difficulty-screen');

            function formatScore(diff) {
                const score = game.p1.best_scores[diff];
                if (!score || score.turns === 999 || score.turns === null) {
                    return "---";
                }
                return `${score.turns} ×ª×•×¨×•×ª | ${score.time} ×©× '`;
            }

            const s4 = formatScore("4x4");
            const s6 = formatScore("6x6");
            const s8 = formatScore("8x8");

            ds.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
                    <div class="container-glass" style="width:420px;">
                        <h2>×©×œ×•× ${game.p1.name}! ğŸ‘‹</h2>
                        <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:20px; text-align:right;">
                            <p>ğŸ† <b>×©×™××™× ××™×©×™×™×:</b></p>
                            <p>4x4: <b>${s4}</b></p>
                            <p>6x6: <b>${s6}</b></p>
                            <p>8x8: <b>${s8}</b></p>
                        </div>
                        <h3>×‘×—×¨ ×¨××”:</h3>
                        <button class="btn blue" onclick="initGame(4,4)">×§×œ (4x4)</button>
                        <button class="btn orange" onclick="initGame(6,6)">×‘×™× ×•× ×™ (6x6)</button>
                        <button class="btn blue" style="background:#8e44ad" onclick="initGame(8,8)">×§×©×” (8x8)</button>
                        <hr style="opacity:0.2; margin: 15px 0;">
                        <button class="btn yellow" style="background:#c0392b; color:white;" onclick="logout()">×™×¦×™××” / ×”×—×œ×£ ××©×ª××©</button>
                    </div>
                </div>
            `;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('status-bar').classList.add('hidden');
            ds.classList.remove('hidden');
        }

        // âœ… FIX: Helper function to get current elapsed time
        function getCurrentTime() {
            return game.startTime ? Math.floor((Date.now() - game.startTime) / 1000) : 0;
        }

        async function check() {
            const [c1, c2] = game.flipped;
            
            console.log(`[CHECK] Checking match. Turns: ${game.turns}, Mode: ${game.mode}`); // Debug
            
            if (c1.img === c2.img) {
                game.matches++;
                playSound('match'); // âœ… Play match sound
                if(game.mode === 'Multi') game.scores[game.currentPlayer]++;
                c1.el.classList.add('matched');
                c2.el.classList.add('matched');

                if (game.matches === (game.rows * game.cols) / 2) {
                    clearInterval(game.timerInterval);
                    playSound('complete'); // âœ… Play complete sound
                    document.getElementById('play-again-btn').classList.remove('hidden');
                    document.getElementById('change-diff-btn').classList.remove('hidden');

                    const diff = game.currentDifficulty;
                    
                    // âœ… FIX: Calculate time BEFORE checking for new record
                    const totalTime = getCurrentTime();
                    
                    console.log(`Game finished! Turns: ${game.turns}, Time: ${totalTime}s`);

                    // Check for new personal best in single player
                    let isNewRecord = false;
                    if (game.mode === 'Single') {
                        const currentBest = game.p1.best_scores[diff];
                        if (!currentBest || currentBest.turns === null || game.turns < currentBest.turns) {
                            isNewRecord = true;
                            game.p1.best_scores[diff] = { turns: game.turns, time: totalTime };
                            playSound('record'); // âœ… Play record sound
                            
                            // Show animated alert
                            setTimeout(() => {
                                alert("ğŸ”¥ ×©×™× ×—×“×©!\n" + 
                                      `${game.turns} ×ª×•×¨×•×ª ×‘-${totalTime} ×©× ×™×•×ª!`);
                            }, 500);
                        }
                    }

                    // âœ… FIX: Send data to server with correct structure
                    const payload = {
                        name: game.p1.name,
                        difficulty: diff,
                        turns: game.turns,
                        time: totalTime,
                        mode: game.mode,  // âœ… Make sure mode is sent
                        win: game.mode === 'Multi' ? (game.scores[1] > game.scores[2]) : null
                    };

                    console.log('=== SENDING TO SERVER ===');
                    console.log('Payload:', JSON.stringify(payload, null, 2));
                    console.log('Game State:', {
                        mode: game.mode,
                        turns: game.turns,
                        totalTime: totalTime,
                        p1: game.p1.name
                    });
                    console.log('========================');

                    fetch('/update_stats', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(payload)
                    })
                    .then(res => res.json())
                    .then(data => {
                        console.log("Server response:", data);
                        if (data.message) {
                            console.log(data.message);
                        }
                    })
                    .catch(err => console.error("Error updating stats:", err));
                }
            } else {
                c1.el.classList.remove('flipped');
                c2.el.classList.remove('flipped');
                if(game.mode === 'Multi') game.currentPlayer = game.currentPlayer === 1 ? 2 : 1;
            }
            game.flipped = [];
            update();
        }

        function update() {
            if (!game.p1) return;
            const sec = getCurrentTime();
            const bar = document.getElementById('status-text');
            if (game.mode === 'Single') {
                const bestData = game.p1.best_scores[game.currentDifficulty];
                const bestTurns = bestData && bestData.turns !== null ? bestData.turns : '---';
                bar.innerHTML = `ğŸ† ×©×™×: ${bestTurns} | ğŸ”„ ×ª×•×¨×•×ª: ${game.turns} | â±ï¸ ${sec}×©'`;
            } else {
                bar.innerHTML = `ğŸ”µ ${game.p1.name}: ${game.scores[1]} | ğŸ”´ ${game.p2.name}: ${game.scores[2]} | ğŸ¯ ×ª×•×¨: ${game.currentPlayer === 1 ? game.p1.name : game.p2.name}`;
            }
        }

        function changeDifficulty() {
            clearInterval(game.timerInterval);
            showDifficultyScreen();
        }

        async function loadLeaderboard() {
            const res = await fetch('/get_game_data');
            const data = await res.json();
            
            const lbDiv = document.getElementById('leaderboard');
            lbDiv.innerHTML = '';
            lbDiv.style.display = 'block';
            
            // Hide other screens
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('difficulty-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            
            const container = document.createElement('div');
            container.className = 'container-glass';
            container.style.margin = '50px auto';
            container.style.maxWidth = '800px';
            
            let html = '<h2>ğŸ† Leaderboard</h2>';
            
            const difficulties = ["4x4", "6x6", "8x8"];
            difficulties.forEach(diff => {
                html += `<h3>Level ${diff}</h3>`;
                html += '<table style="width:100%; border-collapse:collapse; margin-bottom:20px;">';
                html += '<tr style="background:rgba(0,0,0,0.3);"><th>#</th><th>Name</th><th>Turns</th><th>Time</th><th>Wins</th></tr>';
                
                const players = Object.entries(data.leaderboard)
                    .map(([name, info]) => {
                        const score = info.best_scores?.[diff];
                        return {
                            name,
                            turns: score?.turns ?? null,
                            time: score?.time ?? null,
                            wins: info.wins || 0
                        };
                    })
                    .filter(p => p.turns !== null)
                    .sort((a,b) => a.turns - b.turns)
                    .slice(0, 10);
                
                if (players.length === 0) {
                    html += '<tr><td colspan="5" style="text-align:center; padding:10px;">No scores yet</td></tr>';
                } else {
                    players.forEach((p, i) => {
                        html += `<tr style="background:${i % 2 === 0 ? 'rgba(255,255,255,0.05)' : 'transparent'};">`;
                        html += `<td style="padding:8px; text-align:center;">${i + 1}</td>`;
                        html += `<td style="padding:8px;">${p.name}</td>`;
                        html += `<td style="padding:8px; text-align:center;">${p.turns}</td>`;
                        html += `<td style="padding:8px; text-align:center;">${p.time}s</td>`;
                        html += `<td style="padding:8px; text-align:center;">${p.wins}</td>`;
                        html += '</tr>';
                    });
                }
                
                html += '</table>';
            });
            
            html += '<button class="btn blue" onclick="backToLogin()">Back to Login</button>';
            
            container.innerHTML = html;
            lbDiv.appendChild(container);
        }

        function backToLogin() {
            document.getElementById('leaderboard').style.display = 'none';
            document.getElementById('leaderboard').innerHTML = '';
            document.getElementById('login-screen').classList.remove('hidden');
        }

        async function initGame(r, c) {
            // âœ… Ensure mode is set correctly
            if (!game.mode) {
                game.mode = 'Single';
            }
            
            game.rows = r; game.cols = c;
            game.turns = 0; game.matches = 0;
            game.flipped = [];
            game.scores = {1:0, 2:0};
            game.currentPlayer = 1;
            game.startTime = Date.now();  // âœ… Start timer
            game.currentDifficulty = `${r}x${c}`;
            
            console.log(`[INIT] Starting game: ${r}x${c}, Mode: ${game.mode}`); // Debug log

            const data = await (await fetch('/get_game_data')).json();
            const board = document.getElementById('board');
            
            console.log('[INIT] Images received:', data.images.length);
            console.log('[INIT] First 5 images:', data.images.slice(0, 5));

            let size = Math.min((window.innerWidth * 0.8) / c, (window.innerHeight * 0.6) / r, 90);
            board.style.gridTemplateColumns = `repeat(${c}, ${size}px)`;

            let numPairs = (r * c) / 2;
            let deck = [...data.images.slice(0, numPairs), ...data.images.slice(0, numPairs)].sort(() => 0.5 - Math.random());

            board.innerHTML = '';
            deck.forEach(img => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.width = size + 'px'; 
                card.style.height = size + 'px';
                
                // Create image element
                const imgEl = document.createElement('img');
                imgEl.src = `/static/game_images/${img}`;
                imgEl.alt = 'Card';
                imgEl.onerror = function() {
                    console.error('Failed to load image:', img);
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect fill="%23e74c3c" width="100" height="100"/><text x="50" y="50" text-anchor="middle" fill="white" font-size="40">?</text></svg>';
                };
                card.appendChild(imgEl);
                
                card.onclick = () => {
                    if (game.flipped.length < 2 && !card.classList.contains('flipped') && !card.classList.contains('matched')) {
                        console.log('[CLICK] Flipping card with image:', img);
                        card.classList.add('flipped');
                        playSound('flip'); // âœ… Play flip sound
                        game.flipped.push({el: card, img: img});
                        if (game.flipped.length === 2) {
                            game.turns++;
                            setTimeout(check, 1000);
                        }
                        update();
                    }
                };
                board.appendChild(card);
            });

            document.getElementById('difficulty-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('status-bar').classList.remove('hidden');
            document.getElementById('play-again-btn').classList.add('hidden');
            document.getElementById('change-diff-btn').classList.add('hidden');

            if (game.timerInterval) clearInterval(game.timerInterval);
            game.timerInterval = setInterval(update, 1000);
            update();
        }
    </script>
</body>
</html>