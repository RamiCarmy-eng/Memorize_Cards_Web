<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Memory Game Pro</title>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #e67e22;
            --bg: #2c3e50;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: var(--bg);
            color: white;
            margin: 0;
            text-align: center;
        }

        .hidden { display: none !important; }

        /* 住  专砖 */
        #login-screen {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .red { background: #c0392b !important; color: white !important; }

        .container-glass {
            background: var(--glass);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            width: 350px;
        }

        /* 住住 专 */
        #status-bar {
            font-size: 18px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-bottom: 3px solid var(--primary);
            position: sticky; top: 0; z-index: 1000;
        }

        /* 驻转专 注爪 砖转 */
        input {
            padding: 12px; border-radius: 8px; border: none; width: 100%;
            margin: 10px 0; font-size: 16px; box-sizing: border-box;
        }

        .btn {
            padding: 12px 20px; font-size: 16px; margin: 8px 0; cursor: pointer;
            border: none; border-radius: 8px; color: white; font-weight: bold;
            transition: 0.3s; width: 100%;
        }
        .btn:hover { opacity: 0.9; transform: scale(1.02); }
        .blue { background: var(--primary); }
        .orange { background: var(--secondary); }
        .yellow { background: #f1c40f; color: #2c3e50; }

        /*  砖拽 */
        #board { display: grid; gap: 10px; justify-content: center; margin: 20px auto; }
        .card { background: #34495e; cursor: pointer; border-radius: 8px; border: 2px solid #2c3e50; transition: 0.3s; }
        .card.flipped { background: white; transform: rotateY(180deg); }
        .card img { width: 100%; height: 100%; border-radius: 6px; display: none; object-fit: cover; }
        .card.flipped img { display: block; }
        .card.matched { border: 3px solid #27ae60; opacity: 0.6; cursor: default; }
    </style>
</head>
<body>

    <div id="status-bar" class="hidden"></div>

    <div id="login-screen">
    <div class="container-glass">
        <h1> 专</h1>

        <!-- Player 1 -->
        <input type="text"
               id="p1-name"
               placeholder="砖 砖转砖"
               autocomplete="off"
               autocorrect="off"
               spellcheck="false">

        <!-- 砖: type="text" 拽 password -->
        <input type="text"
               id="p1-pass"
               placeholder="住住"
               autocomplete="off"
               autocorrect="off"
               spellcheck="false"
               onfocus="this.type='password'">

        <!-- Player 2 -->
        <div id="p2-area" class="hidden">
            <hr style="opacity:0.2; margin: 20px 0;">

            <input type="text"
                   id="p2-name"
                   placeholder="砖 砖拽 2"
                   autocomplete="off">

            <input type="text"
                   id="p2-pass"
                   placeholder="住住 砖拽 2"
                   autocomplete="off"
                   onfocus="this.type='password'">
        </div>

        <div class="login-buttons">
            <button class="btn blue" onclick="handleAuth()">住 砖拽</button>

            <button id="multi-btn"
                    class="btn orange"
                    onclick="toggleMulti()">
                 爪 
            </button>

            <button class="btn yellow"
                    onclick="loadLeaderboard()">
                  砖
            </button>
        </div>
    </div>
</div>



    <div id="difficulty-screen" class="hidden"></div>

    <div id="game-screen" class="hidden">
        <div id="board"></div>
        <div style="margin-top: 20px; padding-bottom: 40px;">
            <button id="play-again-btn" class="btn blue hidden" style="width:200px" onclick="initGame(game.rows, game.cols)">砖拽 砖</button>
            <button id="change-diff-btn" class="btn yellow hidden" style="width:200px" onclick="changeDifficulty()">砖 专转 拽砖</button>
            <br>
            <button class="btn orange" style="width:200px" onclick="location.reload()">爪</button>
        </div>
    </div>

    <script>


        let game = {
            mode: 'Single', p1: null, p2: null,
            flipped: [], turns: 0, matches: 0,
            currentPlayer: 1, scores: {1:0, 2:0},
            rows: 0, cols: 0, currentDifficulty: '',
            startTime: null, timerInterval: null
        };

       function toggleMulti() {
            const area = document.getElementById('p2-area');
            const btn = document.getElementById('multi-btn'); // 住驻 ID 驻转专 转

            if (!area || !btn) return; // :    爪,  转砖

            area.classList.toggle('hidden');

            if (area.classList.contains('hidden')) {
                game.mode = 'Single';
                btn.innerHTML = ' 爪 '; // 拽住 砖专 住专

                // 拽 砖转 砖拽 2 
                const p2n = document.getElementById('p2-name');
                const p2p = document.getElementById('p2-pass');
                if (p2n) p2n.value = '';
                if (p2p) p2p.value = '';
            } else {
                game.mode = 'Multi';
                btn.innerHTML = ' 砖拽  ( 砖拽 2)'; // 拽住 砖专 驻转
            }
        }

              function logout() {
                // 驻住  转 砖拽 专
                game.p1 = null;
                game.p2 = null;
                game.mode = 'Single';

                // 驻住 砖转 拽 住 
                document.getElementById('p1-name').value = '';
                document.getElementById('p1-pass').value = '';
                const p2name = document.getElementById('p2-name');
                const p2pass = document.getElementById('p2-pass');
                if(p2name) p2name.value = '';
                if(p2pass) p2pass.value = '';

                // 专 住  住转专 砖  砖专
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('difficulty-screen').classList.add('hidden');
                document.getElementById('game-screen').classList.add('hidden');
                document.getElementById('status-bar').classList.add('hidden');

                //  住驻转 砖拽 2, 住转专 转 专 砖
                document.getElementById('p2-area').classList.add('hidden');
            }



        async function verify(name, pass) {
            try {
                const res = await fetch('/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name, password: pass })
                });
                const data = await res.json();
                if (!res.ok) {
                    alert(data.message || "砖 驻专");
                    return null;
                }
                return data; // 砖  砖专 转 -data!
            } catch (err) {
                console.error("Fetch error:", err);
                alert("砖 转拽砖专转 注 砖专转");
                return null;
            }
        }



        async function handleAuth() {
                console.log("Starting Auth..."); // 拽 -F12

                const n1 = document.getElementById('p1-name').value;
                const p1 = document.getElementById('p1-pass').value;

                if (!n1 || !p1) {
                    alert("  砖 住住 砖拽 1");
                    return;
                }

                const u1 = await verify(n1, p1);
                if (!u1) {
                    console.log("Verification failed for Player 1");
                    return;
                }

                // 砖专转 转
                game.p1 = {
                    name: n1,
                    best_scores: u1.user.best_scores || {"4x4": 999, "6x6": 999, "8x8": 999}
                };

                if (game.mode === 'Multi') {
                    const n2 = document.getElementById('p2-name').value;
                    const p2 = document.getElementById('p2-pass').value;
                    if (!n2 || !p2) {
                        alert("  驻专 砖拽 2");
                        return;
                    }
                    const u2 = await verify(n2, p2);
                    if (!u2) return;
                    game.p2 = { name: n2 };
                }

                console.log("Auth success! Moving to difficulty screen...");
                showDifficultyScreen();
            }


        function showDifficultyScreen() {
            const ds = document.getElementById('difficulty-screen');
            const s4 = game.p1.best_scores["4x4"] === 999 ? "---" : game.p1.best_scores["4x4"];
            const s6 = game.p1.best_scores["6x6"] === 999 ? "---" : game.p1.best_scores["6x6"];
            const s8 = game.p1.best_scores["8x8"] === 999 ? "---" : game.p1.best_scores["8x8"];

            ds.innerHTML = `
                <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
                    <div class="container-glass" style="width:400px;">
                        <h2>砖 ${game.p1.name}! </h2>
                        <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; margin-bottom:20px; text-align:right;">
                            <p> <b>砖 砖:</b></p>
                            <p>4x4: <b>${s4}</b> | 6x6: <b>${s6}</b> | 8x8: <b>${s8}</b></p>
                        </div>
                        <h3>专 专:</h3>
                        <button class="btn blue" onclick="initGame(4,4)">拽 (4x4)</button>
                        <button class="btn orange" onclick="initGame(6,6)"> (6x6)</button>
                        <button class="btn blue" style="background:#8e44ad" onclick="initGame(8,8)">拽砖 (8x8)</button>
                        <hr style="opacity:0.2; margin: 15px 0;">
                        <button class="btn yellow" style="background:#c0392b; color:white;" onclick="logout()">爪 / 祝 砖转砖</button>
                    </div>
                </div>
            `;

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('status-bar').classList.add('hidden');
            ds.classList.remove('hidden');
        }



        async function check() {
            const [c1, c2] = game.flipped;
            if (c1.img === c2.img) {
                game.matches++;
                if(game.mode === 'Multi') game.scores[game.currentPlayer]++;
                c1.el.classList.add('matched');
                c2.el.classList.add('matched');

                if (game.matches === (game.rows * game.cols) / 2) {
                    clearInterval(game.timerInterval);
                    document.getElementById('play-again-btn').classList.remove('hidden');
                    document.getElementById('change-diff-btn').classList.remove('hidden');

                    const diff = game.currentDifficulty;

                    if (game.mode === 'Single' && game.turns < game.p1.best_scores[diff]) {
                        game.p1.best_scores[diff] = game.turns;
                        alert(" 砖 砖!");
                    }

                    fetch('/update_stats', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            name: game.p1.name,
                            score: game.mode === 'Single' ? game.turns : null,
                            difficulty: diff,
                            win: game.mode === 'Multi' && game.scores[1] > game.scores[2]
                        })
                    });
                }
            } else {
                c1.el.classList.remove('flipped');
                c2.el.classList.remove('flipped');
                if(game.mode === 'Multi') game.currentPlayer = game.currentPlayer === 1 ? 2 : 1;
            }
            game.flipped = [];
            update();
        }

        function update() {
            if (!game.p1) return;
            const sec = game.startTime ? Math.floor((Date.now() - game.startTime) / 1000) : 0;
            const bar = document.getElementById('status-bar');
            if (game.mode === 'Single') {
                const best = game.p1.best_scores[game.currentDifficulty] || 999;
                bar.innerHTML = ` 砖: ${best === 999 ? '---' : best} |  转专转: ${game.turns} | 憋 ${sec}砖'`;
            } else {
                bar.innerHTML = ` ${game.p1.name}: ${game.scores[1]} |  ${game.p2.name}: ${game.scores[2]} |  转专: ${game.currentPlayer === 1 ? game.p1.name : game.p2.name}`;
            }
        }

        function changeDifficulty() {
            clearInterval(game.timerInterval);
            showDifficultyScreen();
        }

        async function loadLeaderboard() {
            const res = await fetch('/get_game_data');
            const data = await res.json();
            const diff = prompt(" 专 爪? (4x4, 6x6, 8x8)", "4x4");
            if (!["4x4", "6x6", "8x8"].includes(diff)) return;

            let s = ` 驻 10 专转 ${diff}:\n\n`;
            const sorted = Object.entries(data.leaderboard)
                .map(([name, info]) => ({ name, score: info.best_scores[diff] }))
                .filter(p => p.score < 999)
                .sort((a, b) => a.score - b.score).slice(0, 10);

            if (sorted.length === 0) alert(" 注 砖 专 ");
            else {
                sorted.forEach((p, i) => s += `${i+1}. ${p.name}: ${p.score}\n`);
                alert(s);
            }
        }
        async function initGame(r, c) {
            game.rows = r; game.cols = c;
            game.turns = 0; game.matches = 0;
            game.flipped = [];
            game.scores = {1:0, 2:0};
            game.currentPlayer = 1;
            game.startTime = Date.now();
            game.currentDifficulty = `${r}x${c}`;

            const data = await (await fetch('/get_game_data')).json();
            const board = document.getElementById('board');

            let size = Math.min((window.innerWidth * 0.8) / c, (window.innerHeight * 0.6) / r, 90);
            board.style.gridTemplateColumns = `repeat(${c}, ${size}px)`;

            let numPairs = (r * c) / 2;
            let deck = [...data.images.slice(0, numPairs), ...data.images.slice(0, numPairs)].sort(() => 0.5 - Math.random());

            board.innerHTML = '';
            deck.forEach(img => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.width = size + 'px'; card.style.height = size + 'px';
                card.innerHTML = `<img src="/static/game_images/${img}">`;
                card.onclick = () => {
                    if (game.flipped.length < 2 && !card.classList.contains('flipped')) {
                        card.classList.add('flipped');
                        game.flipped.push({el: card, img: img});
                        if (game.flipped.length === 2) {
                            game.turns++;
                            setTimeout(check, 1000);
                        }
                        update();
                    }
                };
                board.appendChild(card);
            });

            document.getElementById('difficulty-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            document.getElementById('status-bar').classList.remove('hidden');

            if (game.timerInterval) clearInterval(game.timerInterval);
            game.timerInterval = setInterval(update, 1000);
            update();
        }

    </script>
</body>
</html>